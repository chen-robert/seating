<html>
<head>
  <title><%= title %></title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/seedrandom/3.0.5/seedrandom.min.js"></script>
  <link rel="stylesheet" href="/styles/main.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
</head>
<body>
  <div class="main">
    <section class="sidebar" id="sidebar">
    </section>
    <table>
      <tbody id="main">
      
      </tbody>
    </table>
  </div>
</body>
<script>
Math.seedrandom("<%= seed %>");

const grid = <%- JSON.stringify(layout) %>;
for(var i = 0; i <= grid.length; i++) {
  let row = "<tr>";
  for(var j = 0; j <= grid[0].length; j++) {
    if(i == 0 || j == 0) {
      let num = "";
      if(i != 0) num = String.fromCharCode("a".charCodeAt(0) + i - 1);
      if(j != 0) num = j;
      row += `<td class="grid--small">${num}</td>`;
    } else {
      row += `<td class="grid--big" data-coords="${(i - 1) + "," + (j - 1)}"><p></p></td>`;
    }

  }
  row += "</tr>";
  
  main.insertAdjacentHTML("beforeend", row);
}

const names = <%- JSON.stringify(names) %>;
const size = grid.length;

for(let i = 0; i < grid.length; i++){
  for(let j = 0; j < grid[i].length; j++){
    if(grid[i][j]) $(`td[data-coords="${i + "," + j}"]`).toggleClass("clicked");
  }  
}

const shuffle = a => {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

const cleanName = name => {
  const parts = name.split(",").map(a => a.trim().charAt(0).toUpperCase());
  
  return parts[1] + parts[0]; 
}

const relabel = () => {
  const curr = names.slice();
  shuffle(curr);
 
  const order = [];
  for(var i = 0; i < size; i++) {
    for(var j = 0; j < size; j++) {  
      if(grid[i][j]) order.push({x: i, y: j});
      $(`td[data-coords="${i + "," + j}"] p`).text("");
    }
  }
  shuffle(order)

  order.sort((a, b) => Math.abs(b.y - 3.5) - Math.abs(a.y - 3.5));

  const list = [];
  for(const {x, y} of order) {
    if(curr.length === 0) continue;
    
    const name = curr.pop();
    $(`td[data-coords="${x + "," + y}"] p`).text(cleanName(name)).prop("title", name);
    list.push({name, x, y});
  }

  list.sort((a, b) => a.name.localeCompare(b.name));

  $("#sidebar").html("");
  for(const {name, x, y} of list) {
    $("#sidebar").append(`
      <div class="sidebar__row">
        <div class="sidebar__title">${name}</div>
        <div class="sidebar__pos">${String.fromCharCode("a".charCodeAt(0) + x)} - ${y + 1}</div>
      </div>
    `)
  }
}

relabel();



</script>
</body>
</html>
